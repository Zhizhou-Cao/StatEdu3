---
title: "CJReport1"
author: "Zhizhou Cao"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readr)
library(sirt)
library(ggpubr)
library(ggplot2)
library(correlation)
library(tibble)
library(knitr)
library(patchwork)
```

#' Questions:
#'1. odd : expert vs student
#'2. even: expert vs student
#'3. with solution : expert vs student
#'4. 2020 actual vs expert 
#'5. 2020 actual vs student


```{r import dataset, message=FALSE}
#'# ----Import dataset----
Actual_grade <- read_csv("ANON_2020-21diagtestSep.csv")

expert_even <- read_csv("experts-even.csv")
expert_odd <- read_csv("experts-odd.csv")
experts_withsolutions <- read_csv("experts-withsolutions.csv")

student_even <- read_csv("students-even.csv")
student_odd <- read_csv("students-odd.csv")

students_withoutsolutions <- read_csv("students-withoutsolutions.csv")

students_withsolutions <- read_csv("students-withsolutions.csv") # 20 judges, 20 comparisons
students_withsolutions1 <- read_csv("students-withsolutions1.csv") # 10 judges, 20 comparisons
students_withsolutions2 <- read_csv("students-withsolutions2.csv") # 10 judges, 40 comparisons

```

# Expert vs Student
```{r ExpertvsStudent}
# WithSolution
# Expert model
sirt_messages <- capture.output(btm_results_expert_all <- sirt::btm(
  data = experts_withsolutions %>%
    select(candidate_chosen, candidate_not_chosen) %>%
    mutate(result = 1) %>%
    data.frame(),
  maxiter = 400,
  fix.eta = 0,
  judge = experts_withsolutions$judge
))
btm_estimates_expert_all <- btm_results_expert_all$effects %>%
  select(individual, expert_theta = theta, expert_se = se.theta)

# Student model
sirt_messages <- capture.output(btm_results_student_all <- sirt::btm(
  data = students_withsolutions %>%
    select(candidate_chosen, candidate_not_chosen) %>%
    mutate(result = 1) %>%
    data.frame(),
  maxiter = 400,
  fix.eta = 0,
  judge = students_withsolutions$judge
))
btm_estimates_student_all <- btm_results_student_all$effects %>%
  select(individual, student_theta = theta, student_se = se.theta)

comparison_all <- left_join(btm_estimates_student_all, btm_estimates_expert_all, by = "individual")

# Even
# Expert

sirt_messages <- capture.output(btm_results_expert_even <- sirt::btm(
  data = expert_even %>%
    select(candidate_chosen, candidate_not_chosen) %>%
    mutate(result = 1) %>%
    data.frame(),
  maxiter = 400,
  fix.eta = 0,
  judge = expert_even$judge
))
btm_estimates_expert_even <- btm_results_expert_even$effects %>%
  select(individual, expert_theta = theta)

# Student
sirt_messages <- capture.output(btm_results_student_even <- sirt::btm(
  data = student_even %>%
    select(candidate_chosen, candidate_not_chosen) %>%
    mutate(result = 1) %>%
    data.frame(),
  maxiter = 400,
  fix.eta = 0,
  judge = student_even$judge
))
btm_estimates_student_even <- btm_results_student_even$effects %>%
  select(individual, student_theta = theta)

#odd
# Expert
sirt_messages <- capture.output(btm_results_expert_odd <- sirt::btm(
  data = expert_odd %>%
    select(candidate_chosen, candidate_not_chosen) %>%
    mutate(result = 1) %>%
    data.frame(),
  maxiter = 400,
  fix.eta = 0,
  judge = expert_odd$judge
))
btm_estimates_expert_odd <- btm_results_expert_odd$effects %>%
  select(individual, expert_theta = theta)

# Student
sirt_messages <- capture.output(btm_results_student_odd <- sirt::btm(
  data = student_odd %>%
    select(candidate_chosen, candidate_not_chosen) %>%
    mutate(result = 1) %>%
    data.frame(),
  maxiter = 400,
  fix.eta = 0,
  judge = student_odd$judge
))
btm_estimates_student_odd <- btm_results_student_odd$effects %>%
  select(individual, student_theta = theta)

```



```{r SSR/SHR table}
# SSR
ssr_table <- tibble(
  Dataset = c("WithSolution", "Even", "Odd"),
  Expert_SSR = c(
    btm_results_expert_all$sepG^2 / (1 + btm_results_expert_all$sepG^2),
    btm_results_expert_even$sepG^2 / (1 + btm_results_expert_even$sepG^2),
    btm_results_expert_odd$sepG^2 / (1 + btm_results_expert_odd$sepG^2)
  ),
  Student_SSR = c(
    btm_results_student_all$sepG^2 / (1 + btm_results_student_all$sepG^2),
    btm_results_student_even$sepG^2 / (1 + btm_results_student_even$sepG^2),
    btm_results_student_odd$sepG^2 / (1 + btm_results_student_odd$sepG^2)
  )
)
# SHR
compute_split_half_irr <- function(decisions_data) {
  decisions <- decisions_data %>%
    mutate(winning_column = 1) %>%
    select(candidate_chosen, candidate_not_chosen, winning_column, judge)
  
  judge_group1 <- decisions %>% distinct(judge) %>% slice_sample(prop = 0.5)
  judge_group2 <- decisions %>% distinct(judge) %>% anti_join(judge_group1, by = "judge")
  
  judgements1 <- decisions %>% semi_join(judge_group1, by = "judge")
  judgements2 <- decisions %>% semi_join(judge_group2, by = "judge")
  
  btm1 <- purrr::quietly(sirt::btm)(judgements1 %>% data.frame, maxit = 400, fix.eta = 0)$result
  btm2 <- purrr::quietly(sirt::btm)(judgements2 %>% data.frame, maxit = 400, fix.eta = 0)$result
  
  merged <- merge(btm1$effects, btm2$effects, by = "individual")
  return(cor(merged$theta.x, merged$theta.y, method = "pearson"))
}

# 定义每组数据集
sh_data_list <- list(
  WithSolution_Expert = experts_withsolutions,
  WithSolution_Student = students_withsolutions,
  Even_Expert = expert_even,
  Even_Student = student_even,
  Odd_Expert = expert_odd,
  Odd_Student = student_odd
)

# 多次 split-half 重复估计
set.seed(10108)
shr_results <- map_df(names(sh_data_list), function(name) {
  data <- sh_data_list[[name]]
  shr_vals <- replicate(100, compute_split_half_irr(data))
  tibble(Group = name, SHR = median(shr_vals))
})

shr_results_split <- shr_results %>%
  separate(Group, into = c("Dataset", "Group"), sep = "_")

# 同样，把 SSR 表整理为长格式
ssr_long <- ssr_table %>%
  pivot_longer(cols = c(Expert_SSR, Student_SSR),
               names_to = "Group",
               names_pattern = "(.*)_SSR",
               values_to = "SSR")

# 合并两个表
reliability_table <- left_join(ssr_long, shr_results_split, by = c("Dataset", "Group")) %>%
  select(Dataset, Group, SSR, SHR)

kable(reliability_table)
```

```{r correlation}
comparison_all <- left_join(btm_estimates_student_all, btm_estimates_expert_all, by = "individual")
comparison_even <- left_join(btm_estimates_student_even, btm_estimates_expert_even, by = "individual")
comparison_odd <- left_join(btm_estimates_student_odd, btm_estimates_expert_odd, by = "individual")

cat("\n=== Correlation Summary ===\n")
list(
  WithSolution = correlation::correlation(comparison_all %>% select(expert_theta, student_theta), method = "pearson"),
  Even = correlation::correlation(comparison_even %>% select(expert_theta, student_theta), method = "pearson"),
  Odd = correlation::correlation(comparison_odd %>% select(expert_theta, student_theta), method = "pearson")
)

```

```{r expert vs student plot}
# Merge & Plot


comparison_all %>%
  ggplot(aes(x = expert_theta, y = student_theta)) +
  geom_point() +
  geom_text(aes(label = individual), hjust = -0.1, vjust = 0, size = 3) +
  geom_errorbar(aes(ymin = student_theta - student_se, ymax = student_theta + student_se), width = 0.05) +
  geom_errorbarh(aes(xmin = expert_theta - expert_se, xmax = expert_theta + expert_se), height = 0.05) +
  geom_smooth(method = "lm", se = FALSE, color = "gray") +
  ggpubr::stat_cor() +
  labs(title = "With Solution: Expert vs Student",
       x = "Expert Theta", y = "Student Theta")


```


```{r Raw visual}
# 给 expert_data 添加 judge_group = "expert"
experts_withsolutions<- experts_withsolutions %>%
  mutate(judge_group = "expert")

# 给 student_data 添加 judge_group = "student"
students_withsolutions <- students_withsolutions %>%
  mutate(judge_group = "student")

withsolution_combined <- bind_rows(experts_withsolutions, students_withsolutions)
rigour_btm_results <- withsolution_combined %>% 
  nest(.by = judge_group) %>% 
  mutate(
    btm_results = purrr::map(data, \(x)
                             purrr::quietly(sirt::btm)(
                               x %>% transmute(candidate_chosen, candidate_not_chosen, col = 1) %>% data.frame,
                               maxit = 400,
                               fix.eta = 0,
                               ignore.ties = TRUE
                             )$result
    )
  ) %>% 
  select(-data)

rigour_scores <- rigour_btm_results %>% 
  mutate(effects = purrr::map(btm_results, \(x) x$effects)) %>% 
  unnest(effects) %>% 
  select(-btm_results)

rigour_scores %>% 
  filter(judge_group %in% c("expert", "student")) %>% 
  select(judge_group, id, propscore, theta) %>% 
  pivot_longer(cols = c(propscore, theta), names_to = "method") %>% 
  mutate(method = case_match(method, "theta" ~ "Bradley-Terry", "propscore" ~ "Raw score")) %>% 
  pivot_wider(names_from = judge_group, values_from = value) %>% 
  ggplot(aes(x = expert, y = student)) +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE, color = "#999999", linewidth = 0.2) +
  geom_point(size = 2) +
  geom_text(aes(label = id), vjust = 1, hjust = 0, nudge_x = 0.01, nudge_y = -0.01, color = "black") +
  ggpubr::stat_cor() +
  facet_wrap(~ method, scales = "free")

```


# Actual vs (Experts/Student)

```{r Actual data, message=FALSE}
# 读取数据
Actual_grade <- read_csv("ANON_2020-21diagtestSep.csv", na = c("", "NA", "-"))

# 只选择题目列
grade_questions <- Actual_grade %>% select(6:25)

# 强制转换为 numeric（排除 "-"）
grade_questions <- grade_questions %>%
  mutate(across(everything(), ~ as.numeric(.)))

# 计算总分、作答人数、平均分
average_scores <- grade_questions %>%
  summarise(across(
    everything(),
    list(
      total = ~ sum(., na.rm = TRUE),
      count = ~ sum(!is.na(.)),
      average = ~ mean(., na.rm = TRUE),
      sd = ~ sd(., na.rm = TRUE)
    ),
    .names = "{.col}_{.fn}"
  )) %>%
  pivot_longer(cols = everything(),
               names_to = c("Question", ".value"),
               names_sep = "_")
# 增加标准误差列
average_scores <- average_scores %>%
  mutate(Question = str_extract(Question, "\\d+")) %>%
  mutate(sem = sd / sqrt(count))

# 查看结果
#print(average_scores)
```


```{r Actual Visualisation, message=FALSE}
# 合并平均得分与 expert theta + 标准误
expert_vs_actual <- btm_estimates_expert_all %>%
  mutate(Question = paste0(individual)) %>%
  left_join(average_scores %>% mutate(Question = str_extract(Question, "\\d+")), by = "Question")

student_vs_actual <- btm_estimates_student_all %>%
  mutate(Question = paste0(individual)) %>%
  left_join(average_scores %>% mutate(Question = str_extract(Question, "\\d+")), by = "Question")



# Expert 图对象
plot_expert <- expert_vs_actual %>%
  ggplot(aes(x = average, y = expert_theta)) +
  geom_point(size = 2) +
  geom_text(aes(label = Question), hjust = -0.1, vjust = 0, size = 3) +
  geom_errorbar(aes(ymin = expert_theta - expert_se, ymax = expert_theta + expert_se), width = 0.05) +
  geom_errorbarh(aes(xmin = average - sem, xmax = average + sem), height = 0.05) +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  ggpubr::stat_cor(method = "pearson") +
  labs(title = "Expert Theta vs Actual Grade",
       x = "Actual Average Grade",
       y = "Expert Perceived Quality (θ)")

# Student 图对象
plot_student <- student_vs_actual %>%
  ggplot(aes(x = average, y = student_theta)) +
  geom_point(size = 2) +
  geom_text(aes(label = Question), hjust = -0.1, vjust = 0, size = 3) +
  geom_errorbar(aes(ymin = student_theta - student_se, ymax = student_theta + student_se), width = 0.05) +
  geom_errorbarh(aes(xmin = average - sem, xmax = average + sem), height = 0.05) +
  geom_smooth(method = "lm", se = FALSE, color = "darkgreen") +
  ggpubr::stat_cor(method = "pearson") +
  labs(title = "Student Theta vs Actual Grade",
       x = "Actual Average Grade",
       y = "Student Perceived Quality (θ)")

plot(plot_expert/plot_student)


```





